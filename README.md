# Дипломный проект: Магазин пельменей
<img width="900" alt="image" src="https://user-images.githubusercontent.com/9394918/167876466-2c530828-d658-4efe-9064-825626cc6db5.png">

Это дипломный проект по созданию и развертыванию инфраструктуры и приложения для интернет-магазина пельменей.
Магазин доступен по адресу https://w.nuf1.fun/

## Структура проекта

Проект состоит из двух репозиториев, каждый из которых хранится в GitLab:

1. **Инфраструктура**: [Репозиторий инфраструктуры](https://gitlab.praktikum-services.ru/std-027-58/infra-momo.git)
2. **Приложение**: [Репозиторий приложения](https://gitlab.praktikum-services.ru/std-027-58/momo-store.git)

### 1. Инфраструктура

В репозитории инфраструктуры с помощью Terraform создаются и настраиваются следующие инфраструктурные объекты:

- **Kubernetes кластер** и рабочие ноды
- **Сеть**: виртуальная сеть, подсети и правила доступа, внешний IP адрес
- **DNS зона**
- **S3 хранилища** для загрузки картинок сайта
- **Сервисные учетные записи**
- **ArgoCD**, **nginx ingress controller**, **prometheus-stack**, **cert-manager**

#### Использование Helm и ArgoCD

Также в инфраструктурном репозитории содержатся манифесты Kubernetes и созданные на их основе Helm чарты. Эти чарты упаковываются в артефакты с помощью GitLab Runner и отправляются в Nexus для дальнейшего использования в ArgoCD (хотя можно настроить деплоймент более простым способом без ArgoCD и Nexus - из gitlab runner с помощью helm upgrade --install).

### 2. Приложение

В репозитории приложения реализован CI/CD процесс, который включает в себя:

- **Анализ кода на уязвимости** с использованием SonarQube и SAST
- **Юнит тесты** бэкэнда
- **Сборку Docker образов** для бэкэнда и фронтэнда на основе Dockerfile
- **Публикацию контейнеров** в GitLab Container Registry на этапе релиза

## Процесс развертывания

Вручную применяем манифесты из папки infra-momo/terra. Внешний IP-адрес балансировщика автоматически прописывается в ДНС зону в A запись с именем сайта. Настраиваются объекты, которые позволят автоматически получить сертификат Let's encrypt.

После того как применеие манифеста terraform закончилось, импортируются сохранённые настройки ArgoCD:

```bash
argocd admin import - < backup-argocd -n argo-cd
```

ArgoCD автоматически загружает Helm чарт из Nexus и применяет его для развертывания приложения. Помимо прочих сущностей, в процессе деплоя, создаётся ingress сущность, для которой автоматически запращивается сертификат от Let's encrypt. После этого сайт становится доступным для посещения и оформления заказов.

## Мониторинг и Логирование

Мониторинг и логирование приложения реализованы с помощью **prometheus-stack**. Чтобы prometheus мог найти объекты для мониторинга, настроена загрузка метрик с использованием сущности **ServiceMonitor**, где указаны путь к метрикам и частота опроса.

Данные метрики можно просматривать в **Grafana** через созданные графики. Также доступны графики, отображающие работу всего кластера и контейнеров приложения.

[Метрики ноды](https://gitlab.praktikum-services.ru/std-027-58/infra-momo/-/blob/diplom/monitoring/node.png)


![Метрики приложения](https://gitlab.praktikum-services.ru/std-027-58/infra-momo/-/blob/diplom/monitoring/deployed%20app%20metrics.png)


![Метрики ingress контроллера](https://gitlab.praktikum-services.ru/std-027-58/infra-momo/-/blob/diplom/monitoring/nginx%20ingress%20controller.png)


![Метрики пода](https://gitlab.praktikum-services.ru/std-027-58/infra-momo/-/blob/diplom/monitoring/pod.png)

## Заключение

Этот проект представляет собой комплексное решение для автоматизации развертывания и мониторинга веб-приложения на основе Kubernetes, с использованием инструментов CI/CD, инфраструктуры как код (IaC), мониторинга и логирования.